graph TD
    %% Algorithm Core
    subgraph "ğŸ¯ best_match Algorithm Core"
        A[ğŸ“¥ Input: query, source]
        A --> B[ğŸ§¹ Normalize query with _norm]
        B --> C{ğŸ” Query empty?}
        C -->|YES| D[âŒ Return None, 0, ""]
        C -->|NO| E[ğŸ”¤ Extract first_letter = query0.upper]
    end
    
    %% Cache Layer
    subgraph "ğŸ’¾ LRU Cache Layer"
        E --> F{ğŸ’° Cache hit for query?}
        F -->|HIT| G[âš¡ Return cached result]
        F -->|MISS| H[ğŸ”„ Proceed to computation]
    end
    
    %% Index Lookup
    subgraph "ğŸ” Candidate Lookup"
        H --> I[ğŸ“š Get candidates from grouped_candidates first_letter]
        I --> J{ğŸ“‹ Candidates exist?}
        J -->|NO| K[âŒ Return None, 0, ""]
        J -->|YES| L[ğŸ”„ Initialize best_score=0, best_row=None]
    end
    
    %% Scoring Loop
    subgraph "ğŸ“Š RapidFuzz Scoring Loop"
        L --> M[ğŸ”„ For each taxon, current, row_dict in candidates]
        M --> N[ğŸ“Š score_taxon = fuzz.ratio query, taxon]
        N --> O[ğŸ“Š score_current = fuzz.ratio query, current]
        
        O --> P{ğŸ† score_taxon >= score_current?}
        P -->|YES| Q{ğŸ“ˆ score_taxon > best_score?}
        P -->|NO| R{ğŸ“ˆ score_current > best_score?}
        
        Q -->|YES| S[âœ… Update: best_score=score_taxon<br/>best_row=row_dict<br/>explanation=sourceâ†’TAXON]
        Q -->|NO| T[â¡ï¸ Continue to next candidate]
        
        R -->|YES| U[âœ… Update: best_score=score_current<br/>best_row=row_dict<br/>explanation=sourceâ†’UPDATED]  
        R -->|NO| T
        
        S --> T
        U --> T
        T --> V{ğŸ”„ More candidates?}
        V -->|YES| M
        V -->|NO| W[ğŸ Scoring complete]
    end
    
    %% Result Processing
    subgraph "ğŸ“¤ Result Processing"
        W --> X[ğŸ“Š Package result: best_row, int best_score, explanation]
        X --> Y[ğŸ’¾ Store in LRU cache maxsize=100,000]
        Y --> Z[ğŸ“¤ Return tuple best_row, score, explanation]
    end
    
    %% Performance Optimizations
    subgraph "âš¡ Performance Features"
        AA[ğŸ” First-Letter Indexing<br/>537k â†’ ~22k candidates<br/>25x speedup]
        BB[ğŸ’¾ LRU Caching<br/>100k entries<br/>O 1 cache hits]
        CC[ğŸ§µ Thread Safety<br/>Pure function<br/>Immutable data]
        DD[ğŸ¯ GIL Release<br/>RapidFuzz C extension<br/>True parallelism]
    end
    
    %% Data Structure Detail
    subgraph "ğŸ—‚ï¸ Index Structure Detail"
        EE["ğŸ“š grouped_candidates<br/>{'A': [tuple1, tuple2, ...],<br/> 'B': [tuple3, tuple4, ...],<br/> 'C': [tuple5, tuple6, ...]}"]
        FF["ğŸ“ Tuple Structure<br/>(taxon_name: str,<br/> current_name: str,<br/> row_dict: dict)"]
        GG["ğŸ—ƒï¸ row_dict Contents<br/>{'mycobank_id': '12345',<br/> 'taxon_name': 'Agaricus...',<br/> 'current_name': 'Agaricus...',<br/> 'authors': 'L. 1753',<br/> 'year': '1753',<br/> 'hyperlink': 'http://...'}"]
    end
    
    %% Example Flow
    subgraph "ğŸ“ Example Execution"
        HH["ğŸ” Query: 'Agaricus campestris'<br/>Source: 'ORG'"]
        II["ğŸ”¤ first_letter = 'A'"]
        JJ["ğŸ“š candidates = grouped_candidates'A'<br/>~22,000 Agaricus species"]
        KK["ğŸ“Š Best match: 'Agaricus campestris'<br/>Score: 100 exact match<br/>Explanation: 'ORG â†’ TAXON'"]
    end
    
    %% Connect main flow
    G --> Z
    K --> Z
    
    %% Connect optimization annotations
    I -.-> AA
    F -.-> BB
    A -.-> CC
    N -.-> DD
    O -.-> DD
    
    %% Connect data structure details
    I -.-> EE
    EE -.-> FF
    FF -.-> GG
    
    %% Connect example
    HH -.-> II
    II -.-> JJ  
    JJ -.-> KK
    
    %% Styling
    classDef inputClass fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef processClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef decisionClass fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef outputClass fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef cacheClass fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    classDef optimizationClass fill:#fce4ec,stroke:#ad1457,stroke-width:1px,stroke-dasharray: 3 3
    classDef exampleClass fill:#f1f8e9,stroke:#558b2f,stroke-width:1px,stroke-dasharray: 5 5
    
    class A,HH inputClass
    class B,E,H,I,L,M,N,O,S,U,W,X,Y processClass
    class C,F,J,P,Q,R,V decisionClass
    class D,G,K,Z,KK outputClass
    class T cacheClass
    class AA,BB,CC,DD,EE,FF,GG optimizationClass
    class II,JJ exampleClass